<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Эко-Герой: Охота за Энергией</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap');
        body { margin: 0; background: #e0f7fa; font-family: 'Inter', Arial, sans-serif; color: #333; }
        #game-container { position: relative; width: 100%; max-width: 1000px; height: auto; aspect-ratio: 5 / 3; margin: 30px auto; border: 3px solid #4caf50; overflow: hidden; background: #a5d6a7; }
        canvas { display: block; width: 100%; height: auto; }
        #score { position: absolute; top: 10px; left: 10px; font-size: 28px; color: #fff; text-shadow: 1px 1px 2px #000; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 20px; font-weight: 600; }
        #level { position: absolute; top: 10px; right: 10px; font-size: 28px; color: #fff; text-shadow: 1px 1px 2px #000; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 20px; font-weight: 600; }
        #health-bar { position: absolute; top: 50px; left: 10px; width: 250px; height: 25px; background: #ddd; border: 3px solid #000; border-radius: 12px; }
        #health-fill { height: 100%; background: linear-gradient(to right, red, yellow, green); border-radius: 10px; transition: width 0.3s; }
        #health-text { position: absolute; top: 50px; left: 10px; width: 250px; text-align: center; font-size: 18px; color: #000; font-weight: 600; }
        #quiz { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); padding: 20px 15px 15px; border-radius: 20px; display: none; text-align: center; z-index: 10; font-size: 18px; border: 1px solid rgba(255, 255, 255, 0.2); animation: scaleIn 0.5s ease-out; width: 80%; max-width: 400px; }
        #quiz.final #skip-quiz { display: none; }
        #quiz h2 { background: linear-gradient(45deg, #4caf50, #2196f3); -webkit-background-clip: text; background-clip: text; color: #333 !important; animation: pulse 1.5s infinite; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin-top: 0; }
        #quiz p { color: #333; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #quiz button { margin: 10px; padding: 10px 20px; background: linear-gradient(45deg, #4caf50, #2196f3); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 16px; font-weight: 600; transition: transform 0.2s, opacity 0.3s; opacity: 0; }
        #quiz button.show { opacity: 1; animation: fadeIn 0.3s ease-in; }
        #quiz button.clicked { transform: scale(1.1); }
        #quiz button:disabled { opacity: 0.5; cursor: not-allowed; }
        #quiz-timer { width: 70%; margin: 10px auto; height: 8px; background: #ddd; border: 2px solid #000; border-radius: 5px; animation: timerPulse 1s infinite; }
        #quiz-timer.warning #quiz-timer-fill { background: #f44336; }
        #quiz-timer-fill { height: 100%; background: linear-gradient(to right, #2196f3, #4caf50); border-radius: 3px; transition: width 0.1s; }
        #quiz-timer-text { font-size: 12px; color: #333; font-weight: 600; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); margin: 5px 0; }
        #end-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; display: none; text-align: center; z-index: 10; font-size: 24px; color: #333; border: 1px solid rgba(255, 255, 255, 0.2); width: 80%; max-width: 400px; }
        #end-screen h2, #end-screen p { background: linear-gradient(45deg, #4caf50, #2196f3); -webkit-background-clip: text; background-clip: text; color: #333 !important; animation: pulse 1.5s infinite; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #end-screen button { margin-top: 20px; padding: 15px 30px; font-size: 22px; font-weight: 700; color: #fff; background: linear-gradient(45deg, #00d4ff, #ff4081); border: none; border-radius: 12px; box-shadow: 0 0 15px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 64, 129, 0.3); cursor: pointer; transition: transform 0.2s, box-shadow 0.3s, background 0.3s; animation: neonPulse 2s infinite ease-in-out; }
        #end-screen button:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(0, 212, 255, 0.7), 0 0 50px rgba(255, 64, 129, 0.5); background: linear-gradient(45deg, #ff4081, #00d4ff); }
        #pause-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); padding: 30px; border-radius: 20px; display: none; text-align: center; z-index: 10; font-size: 28px; color: #333; border: 1px solid rgba(255, 255, 255, 0.2); width: 80%; max-width: 400px; }
        #pause-screen h2, #pause-screen p { background: linear-gradient(45deg, #4caf50, #2196f3); -webkit-background-clip: text; background-clip: text; color: #333 !important; animation: pulse 1.5s infinite; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #pause-screen button { margin-top: 20px; padding: 15px 30px; font-size: 22px; font-weight: 700; color: #fff; background: linear-gradient(45deg, #00d4ff, #ff4081); border: none; border-radius: 12px; box-shadow: 0 0 15px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 64, 129, 0.3); cursor: pointer; transition: transform 0.2s, box-shadow 0.3s, background 0.3s; animation: neonPulse 2s infinite ease-in-out; }
        #pause-screen button:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(0, 212, 255, 0.7), 0 0 50px rgba(255, 64, 129, 0.5); background: linear-gradient(45deg, #ff4081, #00d4ff); }
        #win-screen { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: linear-gradient(135deg, rgba(76, 175, 80, 0.5), rgba(33, 150, 243, 0.5)); 
            backdrop-filter: blur(12px); padding: 25px; border-radius: 20px; 
            display: none; text-align: center; z-index: 10; font-size: 20px; line-height: 1.5; 
            width: 80%; max-width: 380px; max-height: 80vh; overflow-y: auto; 
            color: #333; border: 1px solid rgba(255, 255, 255, 0.3); animation: scaleIn 0.5s ease-out; 
        }
        #win-screen h2, #win-screen p, #win-screen ul { color: #333; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #win-screen ul { padding-left: 20px; text-align: left; margin: 10px 0; }
        #win-screen button { margin-top: 20px; padding: 12px 24px; font-size: 20px; font-weight: 700; color: #fff; background: linear-gradient(45deg, #00d4ff, #ff4081); border: none; border-radius: 12px; box-shadow: 0 0 15px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 64, 129, 0.3); cursor: pointer; transition: transform 0.2s, box-shadow 0.3s, background 0.3s; animation: neonPulse 2s infinite ease-in-out; }
        #win-screen button:hover { transform: scale(1.1); box-shadow: 0 0 25px rgba(0, 212, 255, 0.7), 0 0 50px rgba(255, 64, 129, 0.5); background: linear-gradient(45deg, #ff4081, #00d4ff); }
        #intro-screen { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); padding: 20px; border-radius: 20px; text-align: center; z-index: 100; font-size: 18px; line-height: 1.5; width: 80%; max-width: 400px; max-height: 400px; overflow-y: auto; animation: fadeIn 0.5s; display: block; color: #333; border: 1px solid rgba(255, 255, 255, 0.2); }
        #intro-screen h2, #intro-screen p { background: linear-gradient(45deg, #4caf50, #2196f3); -webkit-background-clip: text; background-clip: text; color: #333 !important; animation: pulse 1.5s infinite; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #intro-screen button { margin-top: 20px; padding: 15px 30px; font-size: 22px; background: linear-gradient(45deg, #4caf50, #2196f3); color: white; border: none; border-radius: 10px; font-weight: 600; transition: transform 0.2s; }
        #intro-screen button:hover { transform: scale(1.05); }
        #touch-controls { display: none; position: relative; margin: 10px auto; width: fit-content; justify-content: center; gap: 20px; }
        #touch-controls button { padding: 20px; font-size: 24px; background: linear-gradient(45deg, #4caf50, #2196f3); color: white; border: none; border-radius: 12px; width: 60px; height: 60px; display: flex; align-items: center; justify-content: center; touch-action: manipulation; box-shadow: 0 0 10px rgba(0,0,0,0.3); transition: transform 0.2s; user-select: none; }
        #touch-controls button:active { transform: scale(0.95); }
        @media (max-width: 600px) {
            #quiz, #end-screen, #pause-screen, #intro-screen, #win-screen {
                font-size: 12px; padding: 10px; width: 90%; max-width: 300px;
            }
            #win-screen { font-size: 11px; padding: 12px; }
            #quiz button, #end-screen button, #win-screen button, #pause-screen button, #intro-screen button {
                font-size: 10px; padding: 6px 12px;
            }
            #quiz-timer { height: 5px; }
            #quiz-timer-text { font-size: 8px; }
            #score, #level { font-size: 16px; }
            #health-bar, #health-text { width: 120px; }
            #health-text { font-size: 12px; }
            #message { font-size: 16px; padding: 10px; }
            #touch-controls { display: flex; }
        }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
        @keyframes scaleIn { from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; } to { transform: translate(-50%, -50%) scale(1); opacity: 1; } }
        @keyframes timerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.05); } }
        @keyframes neonPulse {
            0%, 100% { box-shadow: 0 0 15px rgba(0, 212, 255, 0.5), 0 0 30px rgba(255, 64, 129, 0.3); }
            50% { box-shadow: 0 0 20px rgba(0, 212, 255, 0.7), 0 0 40px rgba(255, 64, 129, 0.4); }
        }
        #message { position: absolute; top: 150px; left: 50%; transform: translateX(-50%); background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); padding: 15px; border-radius: 20px; display: none; font-size: 24px; z-index: 15; color: #333; font-weight: 700; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); animation: pulse 1.5s infinite; border: 1px solid rgba(255, 255, 255, 0.2); }
        #error { position: absolute; top: 80px; left: 10px; color: #d32f2f; font-size: 18px; font-family: 'Inter', Arial, sans-serif; font-weight: 600; background: rgba(255, 255, 255, 0.5); backdrop-filter: blur(10px); padding: 10px; border-radius: 20px; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="canvas" width="1000" height="600"></canvas>
        <div id="score">Очки: 0</div>
        <div id="level">Уровень: 1</div>
        <div id="health-bar"><div id="health-fill" style="width: 100%;"></div></div>
        <div id="health-text">Энергия: 100</div>
        <div id="quiz">
            <h2 id="quiz-title">Викторина по энергосбережению!</h2>
            <div id="quiz-timer"><div id="quiz-timer-fill" style="width: 100%;"></div></div>
            <span id="quiz-timer-text">Осталось: 15 сек</span>
            <p id="question"></p>
            <button id="option1"></button>
            <button id="option2"></button>
            <button id="option3"></button>
            <button id="skip-quiz">Пропустить (-15 энергии)</button>
        </div>
        <div id="end-screen">
            <h2>Игра окончена!</h2>
            <p>Ваши очки: <span id="final-score"></span></p>
            <p>Рекорд: <span id="high-score"></span></p>
            <p id="win-message">Попробуйте набрать 1000 очков и пройти финальную викторину!</p>
            <button onclick="restartGame()">Играть заново</button>
        </div>
        <div id="win-screen">
            <h2>Поздравляем! Вы спасли планету!</h2>
            <p>Благодаря вам энергия сохранена, и мир стал зеленее!</p>
            <ul>
                <li>Выключайте свет, когда выходите из комнаты.</li>
                <li>Используйте светодиодные лампочки.</li>
                <li>Отключайте устройства от розетки, когда не используете.</li>
            </ul>
            <button onclick="restartGame()">Играть заново</button>
        </div>
        <div id="pause-screen">
            <h2>ИГРА НА ПАУЗЕ</h2>
            <p>Нажми P или кнопку ниже, чтобы продолжить</p>
            <button onclick="togglePause()">Продолжить</button>
        </div>
        <div id="intro-screen">
            <h2>Добро пожаловать, Эко-Герой!</h2>
            <p>Эко-Герой, спасай энергию! Собирай батарейки (жёлтые монеты), избегай утечек (красные батарейки) и отвечай на вопросы. Прыгай (W / Пробел / ↑), двигайся (A/D или стрелки), побеждай!</p>
            <button onclick="startGame()">Начать игру</button>
        </div>
        <div id="message"></div>
        <div id="error"></div>
    </div>
    <div id="touch-controls">
        <button id="touch-jump">↑</button>
        <button id="touch-left">←</button>
        <button id="touch-right">→</button>
    </div>

    <script type="text/javascript">
        try {
            // Константы
            const MAX_LEVEL = 6;
            const MAX_COINS = 8;
            const MAX_MONSTERS = 7;
            const MAX_POWERUPS = 3;
            const QUIZ_DURATION = 15000;
            const GRAVITY = 0.4;
            const COIN_LIFETIME = 600;
            const MONSTER_LIFETIME_MIN = 900;
            const MONSTER_LIFETIME_MAX = 1500;
            const BOSS_LIFETIME = { 4: 1500, 5: 1200 };
            const SHIELD_DURATION = 350;
            const FLASH_DURATION = 18;
            const MESSAGE_DURATION = 180;
            const PLAYER_SCALE_DURATION = 30;
            const TEACHER_LIFETIME = 900;
            const TEACHER_LIFETIME_QUIZ_MIN = 300;
            const COLLISION_TOLERANCE = 15;
            const COIN_SPAWN_INTERVAL = 180; // каждые 3 сек (60 фпс)

            // DOM
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            if (!ctx) throw new Error('Canvas не поддерживается');
            const bgCanvas = document.createElement('canvas');
            bgCanvas.width = canvas.width;
            bgCanvas.height = canvas.height;
            const bgCtx = bgCanvas.getContext('2d');
            const staticBgCanvas = document.createElement('canvas');
            staticBgCanvas.width = canvas.width;
            staticBgCanvas.height = canvas.height;
            const staticBgCtx = staticBgCanvas.getContext('2d');
            const scoreEl = document.getElementById('score');
            const levelEl = document.getElementById('level');
            const healthFill = document.getElementById('health-fill');
            const healthText = document.getElementById('health-text');
            const quizEl = document.getElementById('quiz');
            const quizTitle = document.getElementById('quiz-title');
            const questionEl = document.getElementById('question');
            const option1 = document.getElementById('option1');
            const option2 = document.getElementById('option2');
            const option3 = document.getElementById('option3');
            const skipQuiz = document.getElementById('skip-quiz');
            const quizTimerFill = document.getElementById('quiz-timer-fill');
            const quizTimerText = document.getElementById('quiz-timer-text');
            const endScreen = document.getElementById('end-screen');
            const finalScoreEl = document.getElementById('final-score');
            const highScoreEl = document.getElementById('high-score');
            const winMessageEl = document.getElementById('win-message');
            const winScreen = document.getElementById('win-screen');
            const pauseScreen = document.getElementById('pause-screen');
            const introScreen = document.getElementById('intro-screen');
            const messageEl = document.getElementById('message');
            const errorEl = document.getElementById('error');
            const touchLeft = document.getElementById('touch-left');
            const touchRight = document.getElementById('touch-right');
            const touchJump = document.getElementById('touch-jump');

            // Переменные
            let score = 0, lastScore = -1;
            let level = 1, lastLevel = -1;
            let health = 100, lastHealth = -1;
            let gameOver = false;
            let gameStarted = false;
            let quizActive = false;
            let finalQuiz = false;
            let quizTriggered = false;
            let shieldActive = false;
            let shieldTime = 0;
            let messageTimer = 0;
            let flashTimer = 0;
            let flashType = null;
            let flashQueue = [];
            let currentQuiz = null;
            let quizTimer = 0;
            let quizCount = 0;
            let teacher = null;
            let player = { x: 50, y: 490, width: 60, height: 60, vy: 0, jumping: false, scale: 1, scaleTimer: 0 };
            let keys = {};
            let coins = [];
            let monsters = [];
            let powerups = [];
            let boss = null;
            let frameCount = 0;
            let cloudX = 0;
            let grassWave = 0;
            let lastFrameTime = performance.now();
            let lastTime = performance.now();
            let isFocused = true;
            let paused = false;
            let usedQuizIndices = [];
            let startAnimationTimer = 0;
            let coinSpawnTimer = 0; // таймер спавна монет

            const platforms = [
                { x: 0, y: 550, width: 1000, height: 50 },
                { x: 250, y: 400, width: 250, height: 25 },
                { x: 600, y: 350, width: 200, height: 25 }
            ];

            // ... (quizzes и finalQuizQuestion остаются без изменений)

            // === НОВОЕ: Равномерный спавн монет ===
            function updateCoinSpawn() {
                coinSpawnTimer++;
                if (coinSpawnTimer >= COIN_SPAWN_INTERVAL && coins.length < MAX_COINS) {
                    spawnCoin();
                    coinSpawnTimer = 0;
                }
            }

            // === УЛУЧШЕННЫЕ МОНСТРЫ (округлые, злые) ===
            function drawMonsters() {
                ctx.save();
                ctx.shadowBlur = 5;
                ctx.shadowColor = 'rgba(0,0,0,0.3)';
                monsters.forEach(m => {
                    // Тело — красный круг
                    ctx.fillStyle = '#f44336';
                    ctx.beginPath();
                    ctx.arc(m.x + 20, m.y + 20, 20, 0, Math.PI * 2);
                    ctx.fill();

                    // Глаза
                    ctx.fillStyle = '#fff';
                    ctx.beginPath();
                    ctx.arc(m.x + 13, m.y + 15, 5, 0, Math.PI * 2);
                    ctx.arc(m.x + 27, m.y + 15, 5, 0, Math.PI * 2);
                    ctx.fill();

                    ctx.fillStyle = '#000';
                    ctx.beginPath();
                    ctx.arc(m.x + 14, m.y + 16, 2, 0, Math.PI * 2);
                    ctx.arc(m.x + 28, m.y + 16, 2, 0, Math.PI * 2);
                    ctx.fill();

                    // Злой рот
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(m.x + 20, m.y + 25, 8, 0.2, 0.8 * Math.PI);
                    ctx.stroke();
                });
                ctx.restore();
            }

            // === УЛУЧШЕННЫЙ БОСС (злой, с анимацией) ===
            function drawBoss() {
                if (!boss) return;
                const pulse = 1 + 0.05 * Math.sin(frameCount * 0.2);
                ctx.save();
                ctx.shadowBlur = 8;
                ctx.shadowColor = 'rgba(0,0,0,0.5)';
                ctx.scale(pulse, pulse);
                const bx = boss.x / pulse, by = boss.y / pulse;

                // Тело
                ctx.fillStyle = '#333';
                ctx.beginPath();
                ctx.arc(bx + 40, by + 40, 40, 0, Math.PI * 2);
                ctx.fill();

                // Глаза
                ctx.fillStyle = '#f44336';
                ctx.beginPath();
                ctx.arc(bx + 25, by + 30, 10, 0, Math.PI * 2);
                ctx.arc(bx + 55, by + 30, 10, 0, Math.PI * 2);
                ctx.fill();

                ctx.fillStyle = '#fff';
                ctx.beginPath();
                ctx.arc(bx + 27, by + 28, 4, 0, Math.PI * 2);
                ctx.arc(bx + 57, by + 28, 4, 0, Math.PI * 2);
                ctx.fill();

                // Зубы
                ctx.fillStyle = '#fff';
                for (let i = 0; i < 3; i++) {
                    ctx.beginPath();
                    ctx.moveTo(bx + 25 + i*10, by + 50);
                    ctx.lineTo(bx + 30 + i*10, by + 58);
                    ctx.lineTo(bx + 35 + i*10, by + 50);
                    ctx.fill();
                }
                ctx.restore();
            }

            // === WASD + Стрелки + Пробел ===
            document.addEventListener('keydown', e => {
                if (e.code === 'KeyP' && gameStarted && !gameOver && !quizActive) {
                    togglePause();
                }
                if (!quizActive) {
                    if (e.code === 'KeyW' || e.code === 'Space' || e.code === 'ArrowUp') {
                        keys['Space'] = true;
                    }
                    if (e.code === 'KeyA' || e.code === 'ArrowLeft') keys['ArrowLeft'] = true;
                    if (e.code === 'KeyD' || e.code === 'ArrowRight') keys['ArrowRight'] = true;
                }
            });

            document.addEventListener('keyup', e => {
                if (e.code === 'KeyW' || e.code === 'Space' || e.code === 'ArrowUp') {
                    keys['Space'] = false;
                }
                if (e.code === 'KeyA' || e.code === 'ArrowLeft') keys['ArrowLeft'] = false;
                if (e.code === 'KeyD' || e.code === 'ArrowRight') keys['ArrowRight'] = false;
            });

            // === Обновление в gameLoop ===
            function update() {
                if (!gameStarted || gameOver || !isFocused || paused || quizActive) return;

                frameCount++;
                updateCoinSpawn(); // <-- равномерный спавн

                // ... остальной код update без изменений
            }

            // === Остальные функции без изменений ===
            // (вставьте сюда весь остальной код из оригинала, кроме drawMonsters, drawBoss, keydown/keyup и updateCoinSpawn)

            // Инициализация
            addTouchControls();
            initStaticBackground();
            drawBackground();
            updateUI();

        } catch (e) {
            console.error('Ошибка:', e);
            showError('Ошибка загрузки. Перезагрузите страницу.');
        }
    </script>
</body>
</html>
